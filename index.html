<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Hand Particles Mobile</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui {
            position: absolute; top: 10px; left: 10px; color: #0ff;
            background: rgba(0,0,0,0.5); padding: 8px; border-radius: 5px;
            font-size: 12px; pointer-events: none; z-index: 100;
        }
        #video_container { position: absolute; bottom: 10px; right: 10px; width: 100px; height: 75px; border: 2px solid #0ff; border-radius: 5px; overflow: hidden; transform: scaleX(-1); }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <div id="ui">
        <div id="status">Models loading...</div>
        <div id="shape_name">Shape: Sphere</div>
    </div>
    
    <div id="video_container">
        <video id="input_video"></video>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- Settings ---
        const isMobile = window.innerWidth < 768;
        const P_COUNT = isMobile ? 5000 : 15000; // Mobile par particles kam
        const videoElement = document.getElementById('input_video');
        const status = document.getElementById('status');
        const shapeLabel = document.getElementById('shape_name');

        // --- Three.js Setup ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 30;

        const renderer = new THREE.WebGLRenderer({ antialias: !isMobile });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        // --- Particle Geometry ---
        const geometry = new THREE.BufferGeometry();
        const pos = new Float32Array(P_COUNT * 3);
        const col = new Float32Array(P_COUNT * 3);

        for(let i=0; i<P_COUNT; i++) {
            pos[i*3] = (Math.random()-0.5)*50;
            pos[i*3+1] = (Math.random()-0.5)*50;
            pos[i*3+2] = (Math.random()-0.5)*50;
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(col, 3));

        const mat = new THREE.PointsMaterial({
            size: isMobile ? 0.3 : 0.15,
            vertexColors: true,
            blending: THREE.AdditiveBlending,
            transparent: true,
            depthWrite: false
        });

        const points = new THREE.Points(geometry, mat);
        scene.add(points);

        // --- Advanced Shapes Generation ---
        function createShapes() {
            const s = { sphere: [], heart: [], saturn: [], flower: [] };
            for(let i=0; i<P_COUNT; i++) {
                // Sphere
                s.sphere.push(new THREE.Vector3().randomDirection().multiplyScalar(15));
                
                // Heart
                const t = Math.random() * Math.PI * 2;
                s.heart.push(new THREE.Vector3(
                    8 * Math.pow(Math.sin(t), 3),
                    6.5 * Math.cos(t) - 2.5 * Math.cos(2*t) - Math.cos(3*t) - 0.5 * Math.cos(4*t),
                    (Math.random()-0.5)*3
                ));

                // Saturn
                if(Math.random() > 0.4) {
                    const angle = Math.random() * Math.PI * 2;
                    const r = 15 + Math.random() * 5;
                    s.saturn.push(new THREE.Vector3(Math.cos(angle)*r, (Math.random()-0.5)*2, Math.sin(angle)*r));
                } else {
                    s.saturn.push(new THREE.Vector3().randomDirection().multiplyScalar(10));
                }

                // Flower
                const angle = Math.random() * Math.PI * 2;
                const r = 10 * Math.sin(5 * angle); // 5 petals
                s.flower.push(new THREE.Vector3(Math.cos(angle)*r, Math.sin(angle)*r, (Math.random()-0.5)*5));
            }
            return s;
        }

        const allShapes = createShapes();
        const shapeKeys = Object.keys(allShapes);
        let currentShapeIdx = 0;

        // --- AI Tracking ---
        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5 });

        let hX=0, hY=0, pinch=false;

        hands.onResults(res => {
            status.innerText = "Hand Active âœ…";
            if(res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                const lm = res.multiHandLandmarks[0];
                hX = (0.5 - lm[8].x) * (isMobile ? 50 : 70);
                hY = (0.5 - lm[8].y) * 40;
                pinch = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y) < 0.05;
            }
        });

        const cam = new Camera(videoElement, {
            onFrame: async() => { await hands.send({image: videoElement}); },
            width: 480, height: 360, facingMode: 'user'
        });
        cam.start();

        // --- Animation ---
        let clock = new THREE.Clock();
        function update() {
            requestAnimationFrame(update);
            const time = clock.getElapsedTime();
            
            // Auto switch shape every 6 seconds
            currentShapeIdx = Math.floor(time / 6) % shapeKeys.length;
            const targetName = shapeKeys[currentShapeIdx];
            const targetData = allShapes[targetName];
            shapeLabel.innerText = "Shape: " + targetName.toUpperCase();

            points.position.lerp(new THREE.Vector3(hX, hY, 0), 0.1);
            points.rotation.y += 0.005;

            const posAttr = geometry.attributes.position;
            const colAttr = geometry.attributes.color;

            for(let i=0; i<P_COUNT; i++) {
                const i3 = i*3;
                // Morphing Logic
                posAttr.array[i3] += (targetData[i].x - posAttr.array[i3]) * 0.06;
                posAttr.array[i3+1] += (targetData[i].y - posAttr.array[i3+1]) * 0.06;
                posAttr.array[i3+2] += (targetData[i].z - posAttr.array[i3+2]) * 0.06;

                // Color Logic
                if(pinch) {
                    colAttr.array[i3] = Math.sin(time*2) * 0.5 + 0.5;
                    colAttr.array[i3+1] = 0;
                    colAttr.array[i3+2] = 1;
                } else {
                    // Hand movement se rang badlega
                    colAttr.array[i3] = 0.2 + (hX/100);
                    colAttr.array[i3+1] = 0.8;
                    colAttr.array[i3+2] = 1.0 - (hY/100);
                }
            }

            posAttr.needsUpdate = true;
            colAttr.needsUpdate = true;
            renderer.render(scene, camera);
        }
        update();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
